#!/bin/bash
echo "Unat"

ip netns del urouter-virtual-nat &>/dev/null
ip li del v-eth1 &>/dev/null
sleep 0.2
ip netns add urouter-virtual-nat
sleep 0.2

ip link add v-eth1 type veth peer name v-peer1
sleep 0.2

ip link set v-peer1 netns urouter-virtual-nat
sleep 0.2

ifconfig v-eth1 10.20.1.1
ip addr add 10.20.1.1/24 dev v-eth1
ip link set v-eth1 up
sleep 0.2


ip netns exec urouter-virtual-nat ip addr add 10.20.1.2/24 dev v-peer1
ip netns exec urouter-virtual-nat ip link set v-peer1 up
ip netns exec urouter-virtual-nat ip link set lo up
sleep 0.2


ip netns exec urouter-virtual-nat ip route add default via 10.20.1.1
ip netns exec urouter-virtual-nat ifconfig v-peer1 add 2001:470:1f14:525::4
ip netns exec urouter-virtual-nat iptables -A INPUT -s 91.239.97.17 -p icmp -j DROP
sleep 0.2

iptables --append FORWARD --in-interface v-eth1 -j ACCEPT

#ip netns exec urouter-virtual-nat ifconfig

#alias unat="ip netns exec urouter-virtual-nat"

#ip netns exec urouter-virtual-nat /bin/bash --rcfile <(echo "PS1=\"unat> \"")

VETH1IPV6=fd00::1
VPEER1IPV6=fd00::2
ip -6 addr add ${VETH1IPV6}/64 dev v-eth1

ip netns exec urouter-virtual-nat ip li set dev lo up
ip netns exec urouter-virtual-nat ip -6 addr add ${VPEER1IPV6}/64 dev v-peer1
ip netns exec urouter-virtual-nat ip -6 route add default dev v-peer1 via ${VETH1IPV6}
sysctl -w net.ipv6.conf.all.forwarding=1
ip6tables -t nat -A POSTROUTING -j MASQUERADE
