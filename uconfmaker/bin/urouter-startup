#!/bin/bash

###
#conf cache maker
###
mount -t tmpfs -o size=20m tmpfs /urouter/uroutertmp
mkdir -p /urouter/uroutertmp/uconf
urouter_dir="/urouter"
cp /urouter/uconf/urouter.uconf /urouter/uroutertmp/uconf/
rm /urouter/urouter.uconf
ln -s /urouter/uroutertmp/uconf/urouter.uconf /urouter/urouter.uconf

## .urouter files
cp /urouter/uconf/*.urouter /urouter/uroutertmp/uconf/


source $urouter_dir/urouter.uconf
source $ulang

#web service
php-fpm7.0 -c /urouter/uconfmaker/etc/php/php.ini -g /var/run/php/urouter.pid -y /urouter/uconfmaker/etc/php/php-fpm.conf -R

###
#Network 
###
#/urouter/uroutertmp/bin/urouter-vnat
$binlocuconf/urouter-vnat

ip -6 route add 2001:470:1f14:525::4 dev v-eth1
ifconfig $cableinterfaceuconf inet6 add $tunnelbrokerip1block::1/64 > /dev/null
ifconfig $cableinterfaceuconf inet6 add $tunnelbrokerip1block::2/64 > /dev/null
ifconfig $cableinterfaceuconf inet6 add $tunnelbrokerip1block::3/64 > /dev/null

service radvd restart

#Tunnel Broker
bash $binlocuconf/urouter-tunnelbroker
#DHCP server
bash $etclocuconf/dhcp/dhcpd.conf
bash $etclocuconf/dhcp/dhcpd6.conf
ln -s $uetc/dhcp/dhcpd.conf /etc/dhcp/
ln -s $uetc/dhcp/dhcpd6.conf /etc/dhcp/
ln -s $uetc/default/isc-dhcp-server /etc/default/
service isc-dhcp-server restart
service isc-dhcp-server6 restart


#Sysct enable NAT
sysctl -w net.ipv4.ip_forward=1
sysctl -w net.ipv6.conf.all.forwarding=1

#bind9
bash $etclocuconf/bind/named.conf
ln -s $uetc/bind/named.conf /etc/bind/
service bind9 restart
###
#PPPOE
###

bash $etclocuconf/ppp/provider
ln -s $uetc/ppp/provideruconf /etc/ppp/peers/provideruconf > /dev/null
#####
mkdir -p $uetc/ppp/
cp $etclocuconf/ppp/ip-up $uetc/ppp/
cp $etclocuconf/ppp/ip-down $uetc/ppp/
####
ln -s $uetc/ppp/ip-up /etc/ppp/ip-up > /dev/null
ln -s $uetc/ppp/ip-down /etc/ppp/ip-down > /dev/null

pppd call provideruconf

###
#
###
mkdir -p $ubin
cp $binlocuconf/* $ubin
echo '#!/bin/bash
urouter_dir="/urouter"
source $urouter_dir/urouter.uconf
PATHuconf=`echo $PATH`
export PATH="$PATHuconf:$ubin"
alias unat="ip netns exec urouter-virtual-nat"
' > /etc/uroutherpath
chmod 755 /etc/uroutherpath


###
#Terminal Programs start
###
ssh root@127.0.0.1 -p $sshportuconf "sleep 15 && $binlocuconf/urouter-s-bash 1 $binlocuconf/urouter-system-control "&
#ssh root@127.0.0.1 -p $sshportuconf $binlocuconf/urouter-s-bash 2 $binlocuconf/urouter-weather &
#ssh root@127.0.0.1 -p $sshportuconf $binlocuconf/urouter-s-bash 3 bwm-ng &
#ssh root@127.0.0.1 -p $sshportuconf $binlocuconf/urouter-s-bash 4 htop --sort-key=PERCENT_CPU &
#ssh root@127.0.0.1 -p $sshportuconf $binlocuconf/urouter-s-bash 5 $binlocuconf/urouter-w-s-loop &
#ssh root@127.0.0.1 -p $sshportuconf $binlocuconf/urouter-w-s-loop &
